#cloud-config
package_update: true
package_upgrade: true

write_files:
  - path: /usr/local/bin/setup-lxd.sh
    permissions: '0755'
    content: |
      #!/bin/bash

      snap remove lxd
      snap install lxd
      
      # Extract join token
      JOIN_TOKEN=eyJzZXJ2ZXJfbmFtZSI6ImZyZWUtYmlyZCIsImZpbmdlcnByaW50IjoiYjE5YjkxNWE3MWY2NTgzM2FlMGQ0M2Y2YzVhYTFmZTY1NDExMTYzMTcxNjJmNTdkOWUwMzM5ODcwYjQ1N2M3ZiIsImFkZHJlc3NlcyI6WyIxMC4xMC4xMC4yOjg0NDMiXSwic2VjcmV0IjoiYzY5MzQwM2FhN2ZhNWZlMjNjMzdmYTcwMjk3ZTIxMjFlYTMzY2VmOTVlN2QxM2E4NTg0ZmUwMDZhYjliMjY1YyIsImV4cGlyZXNfYXQiOiIyMDI1LTAzLTMwVDIxOjE0OjI4Ljg3MjMwNTcwNCswNzowMCJ9
      
      # 1. 'yes' Use LXD Cluster
      # 2. '' Use default ip 
      # 3. 'yes' joining an existing cluster
      # 4. ${JOIN_TOKEN} join token
      # 5. 'yes' confirm all data lost
      # 6. '' confirm default storage pool
      # 7. 'yes' print yaml 
      # Initialize LXD with the join token
      printf "yes\n\nyes\n${JOIN_TOKEN}\nyes\n\nyes\n" | lxd init 
      
      # Join resource group
      lxc cluster group add free-bird cloudboi-resource

runcmd:
  - /usr/local/bin/setup-lxd.sh
